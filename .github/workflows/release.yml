name: Release Build and Publish

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-staging:
    name: Release Build against Staging Dalamud and deploy to MyDalamudPlugins
    runs-on: windows-2022

    env:
      PLUGIN_NAME: NativeMeters
      DALAMUD_VERSION_NAME: "Staging"
      DALAMUD_VERSION_URL: "https://goatcorp.github.io/dalamud-distrib/stg/latest.zip"
      BUILD_OUTPUT: ${{ github.workspace }}\build_out

    steps:
      - name: Checkout and Initialise
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x.x'

      - name: Download and extract Dalamud (${{ env.DALAMUD_VERSION_NAME }})
        run: |
          mkdir -p "$env:AppData\XIVLauncher\addon\Hooks\dev"
          Invoke-WebRequest -Uri "${{ env.DALAMUD_VERSION_URL }}" -OutFile "dalamud.zip"
          Expand-Archive -Path "dalamud.zip" -DestinationPath "$env:AppData\XIVLauncher\addon\Hooks\dev" -Force

      - name: Build Release (${{ env.DALAMUD_VERSION_NAME }})
        run: |
          dotnet restore `
            && dotnet build --no-restore --configuration Release --output "${{ env.BUILD_OUTPUT }}" `
            && dotnet test --no-build --configuration Release

      - name: Prepare zip file
        shell: pwsh
        run: |
          mkdir output -Force
          Copy-Item "${{ env.BUILD_OUTPUT }}\${{ env.PLUGIN_NAME }}.json" -Destination "output\${{ env.PLUGIN_NAME }}.json" -Force
          Compress-Archive -Path "${{ env.BUILD_OUTPUT }}\*" -DestinationPath "output\latest.zip"

      - name: Upload zip to GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: output/latest.zip
        continue-on-error: true

      - name: Clone plugin hosting repo
        run: git clone https://github.com/${{ github.repository_owner }}/MyDalamudPlugins.git

      - name: Create plugins directory and copy files
        shell: pwsh
        run: |
          # Create the directory path if it doesn't exist
          $destDir = "MyDalamudPlugins/plugins/${{ env.PLUGIN_NAME }}"
          if (!(Test-Path $destDir)) { New-Item -ItemType Directory -Force -Path $destDir }
          
          # Now copy the files
          Copy-Item output/latest.zip -Destination "$destDir/latest.zip" -Force
          Copy-Item "output/${{ env.PLUGIN_NAME }}.json" -Destination "$destDir/${{ env.PLUGIN_NAME }}.json" -Force

      - name: Update repo.json with version and timestamp
        shell: pwsh
        run: |
          $pluginJson = Get-Content "${{ env.BUILD_OUTPUT }}\${{ env.PLUGIN_NAME }}.json" | ConvertFrom-Json
          $repoJsonPath = "MyDalamudPlugins/repo.json"
          $repoJson = Get-Content $repoJsonPath | ConvertFrom-Json
          
          if ($repoJson -isnot [System.Collections.IList]) { $repoJson = @($repoJson) }
          
          $tagName = "${{ github.event.release.tag_name }}"
          $downloadUrl = "https://github.com/${{ github.repository }}/releases/download/$tagName/latest.zip"
          
          foreach ($plugin in $repoJson) {
            if ($plugin.InternalName -eq $pluginJson.InternalName) {
              $plugin.DalamudApiLevel = $pluginJson.DalamudApiLevel
              $plugin.AssemblyVersion = $pluginJson.AssemblyVersion
              $plugin.LastUpdated = [int][double]::Parse((Get-Date -UFormat %s))
              $plugin.ImageUrls = $pluginJson.ImageUrls
              $plugin.DownloadLinkInstall = $downloadUrl
              $plugin.DownloadLinkUpdate = $downloadUrl
              $plugin.DownloadLinkTesting = $downloadUrl
            }
          }
          
          $repoJson | ConvertTo-Json -Depth 100 | Set-Content $repoJsonPath

      - name: Commit and push to MyDalamudPlugins
        run: |
          cd MyDalamudPlugins
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Update ${{ env.PLUGIN_NAME }} to ${{ github.event.release.tag_name }}"
          git push https://x-access-token:${{ secrets.MYDALAMUDPLUGINS_TOKEN }}@github.com/${{ github.repository_owner }}/MyDalamudPlugins.git HEAD:main